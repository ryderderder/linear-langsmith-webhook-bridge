# Linear Webhook & LangSmith Integration Architecture

This document explains how Linear webhooks work with LangSmith agents, based on official API documentation.

## Understanding the Flow

### What This Bridge Does

```
Linear Event → Linear Webhook → Our Bridge → LangSmith Agent SDK → Agent Response
    (Issue)      (HTTP POST)     (Middleware)    (Async Call)         (Processed)
```

**Important**: This is NOT a direct webhook-to-webhook integration. Here's why:

1. **Linear** has **OUTGOING** webhooks - it sends HTTP POST requests when events occur
2. **LangSmith Agent Builder** is called via **SDK** - it doesn't have inbound webhook URLs
3. **Our bridge** is the middleware that receives Linear webhooks and invokes LangSmith agents

### Why We Need a Bridge

LangSmith Agent Builder doesn't expose webhook endpoints for external services to trigger agents. Instead, you interact with agents through the LangGraph SDK. This bridge:

- Receives webhook POST requests from Linear
- Validates signatures for security
- Transforms Linear events into agent-friendly messages
- Calls the LangSmith agent via SDK
- Handles responses asynchronously

## Linear Webhooks - Official Behavior

### Callback URL Configuration

When you create a webhook in Linear (Settings → API → Webhooks), you provide:

**URL**: `https://your-deployment.com/webhook/linear?token=YOUR_SECRET`
- Must be publicly accessible HTTPS (non-localhost)
- Will receive HTTP POST requests
- Must respond with HTTP 200 within 5 seconds

**Events**: Select which resource types to monitor
- Issue, Comment, Project, Cycle, Label, etc.
- Can filter to specific teams or all public teams

**Signing Secret**: Automatically generated by Linear
- Used for HMAC-SHA256 signature verification
- Find it on webhook detail page after creation

### Webhook Delivery Behavior

**Headers Linear Sends:**
```
Accept-Charset: utf-8
Content-Type: application/json; charset=utf-8
Linear-Delivery: <uuid>           # Unique delivery ID
Linear-Event: Issue                # Event type
Linear-Signature: <hex_signature>  # HMAC-SHA256 hex digest
User-Agent: Linear-Webhook
```

**Payload Structure:**
```json
{
  "action": "create|update|remove",
  "type": "Issue|Comment|Project|Cycle|Label",
  "createdAt": "2025-12-29T07:00:00.000Z",
  "data": {
    "id": "...",
    "title": "...",
    "description": "...",
    // Full GraphQL entity structure
  },
  "updatedFrom": {
    // For updates, previous values of changed fields
  },
  "organizationId": "...",
  "webhookId": "...",
  "webhookTimestamp": 1735459200000
}
```

**Retry Logic:**
- If endpoint is unavailable, takes >5 seconds, or returns non-200
- Linear retries: after 1 minute, 1 hour, 6 hours
- After 3 failed attempts, webhook may be disabled

**Security:**
- Signature verification using HMAC-SHA256
- Payload signed with webhook's signing secret
- Signature is hex-encoded, included in `Linear-Signature` header
- Compare against computed signature using raw request body

## LangSmith Agent Builder - How It Works

### Agent Invocation (Not Webhooks)

LangSmith Agent Builder agents are called programmatically via SDK:

```python
from langgraph_sdk import get_client

client = get_client(
    url="https://your-deployment.langsmith.com",
    api_key="lsv2_pt_...",
    headers={"X-Auth-Scheme": "langsmith-api-key"}
)

# Create conversation thread
thread = await client.threads.create()

# Call agent
async for chunk in client.runs.stream(
    thread_id=thread["thread_id"],
    assistant_id="your-agent-id",
    input={
        "messages": [
            {"type": "human", "content": "Process this Linear event..."}
        ]
    },
    stream_mode="events"
):
    # Process response
    pass
```

**Key Points:**
- Agents don't have webhook URLs
- You call them via SDK/API
- Authentication via Personal Access Token (PAT)
- Supports both simple runs and streaming responses

### What LangSmith Webhooks Actually Are

LangSmith **does** have webhooks, but they're **OUTGOING**:

- **Automation Rules**: Trigger webhooks when traces meet certain conditions
- **Alerts**: Send webhooks when monitoring thresholds are exceeded
- **Prompt Syncing**: Notify external systems of prompt changes

These are for LangSmith to **send data OUT**, not receive data in.

## Security Implementation

### Signature Verification (Required for Production)

Linear uses HMAC-SHA256 with hexadecimal encoding:

```python
import hmac
import hashlib

def verify_linear_signature(payload: bytes, signature: str, secret: str) -> bool:
    # Compute expected signature from raw body
    expected_signature = hmac.new(
        secret.encode('utf-8'),
        payload,
        hashlib.sha256
    ).hexdigest()  # hex encoding (not base64!)
    
    # Constant-time comparison
    return hmac.compare_digest(signature, expected_signature)

# In webhook handler:
raw_body = request.get_data()  # Get raw bytes, not parsed JSON
signature = request.headers.get('Linear-Signature')
if not verify_linear_signature(raw_body, signature, LINEAR_SECRET):
    return {"error": "Invalid signature"}, 401
```

**Critical Details:**
1. **Use RAW request body** - before JSON parsing
2. **Hexadecimal encoding** - Linear uses `.hexdigest()`, not base64
3. **Constant-time comparison** - `hmac.compare_digest()` prevents timing attacks
4. **Get secret from Linear** - shown on webhook detail page after creation

### Additional Security Layers

Our bridge implements defense in depth:

1. **Signature Verification**: Validates webhook is from Linear
2. **Secret Token**: Optional query parameter for additional auth
3. **Rate Limiting**: 50 requests/minute per IP, 100/hour overall
4. **HTTPS Only**: Linear requires HTTPS endpoints
5. **Timestamp Validation**: Could check `webhookTimestamp` for replay protection

## Configuration Guide

### 1. Create LangSmith Agent

1. Build your agent in LangSmith Agent Builder
2. Get credentials:
   - Agent ID (from settings → View code snippets)
   - API URL (your deployment URL)
   - API Key (create Personal Access Token)

### 2. Deploy the Bridge

Deploy to Replit, Railway, or any Python host:

```bash
# Set environment variables
LANGSMITH_API_KEY=lsv2_pt_xxxxx
LANGSMITH_API_URL=https://your-deployment.langsmith.com
LANGSMITH_AGENT_ID=your-agent-id
LINEAR_SIGNING_SECRET=<from_linear_webhook_page>
WEBHOOK_SECRET_TOKEN=<random_secret>
```

### 3. Create Linear Webhook

In Linear (Settings → API → Webhooks):

1. Click "New webhook"
2. **URL**: `https://your-deployment.com/webhook/linear?token=YOUR_SECRET`
3. **Label**: "LangSmith Integration"
4. **Resource Types**: Select events (Issue, Comment, etc.)
5. **Team**: Choose team or "All public teams"
6. Save and copy the **Signing Secret**

### 4. Update Bridge Configuration

Add the signing secret to your environment:

```bash
LINEAR_SIGNING_SECRET=<paste_signing_secret_here>
```

### 5. Test the Integration

1. Create or update an issue in Linear
2. Check your bridge logs for webhook receipt
3. Verify agent was triggered successfully
4. Check Linear webhook logs for delivery status

## Troubleshooting

### Webhook Not Arriving

- **Check URL**: Must be publicly accessible HTTPS
- **Verify events**: Ensure you selected correct resource types
- **Check Linear logs**: Go to webhook detail page → Deliveries
- **Firewall**: Ensure no firewall blocking Linear IPs

### Signature Verification Failing

- **Check secret**: Verify `LINEAR_SIGNING_SECRET` matches Linear's value
- **Raw body**: Ensure using raw bytes, not parsed JSON
- **Encoding**: Linear uses hexadecimal, not base64
- **Timing**: Verify using `hmac.compare_digest()`

### Agent Not Responding

- **Run test script**: `python test_langsmith_connection.py`
- **Check credentials**: Verify API key, URL, agent ID
- **Message format**: Must use `{"type": "human", "content": "..."}"`
- **Logs**: Check bridge logs for error details

### Timeouts

- **5-second limit**: Linear expects response within 5 seconds
- **Async processing**: Agent call is async, should return quickly
- **Retries**: Linear retries failed deliveries automatically

## Rate Limits

### Linear API
- API key: 1,500 requests/hour per user
- Complexity-based: 250,000 points/hour per user

### Our Bridge
- 50 requests/minute per IP (per endpoint)
- 100 requests/hour overall

### LangSmith
- Depends on your plan
- Agent Builder usage typically unlimited for core features

## Best Practices

1. **Always verify signatures** - Don't skip in production
2. **Use secrets securely** - Never commit to git
3. **Monitor webhook logs** - Both Linear and bridge sides
4. **Handle errors gracefully** - Return 200 even for processing errors
5. **Log thoroughly** - Include webhook IDs for tracking
6. **Filter events** - Only subscribe to events you need
7. **Test with Linear's test delivery** - Before going live
8. **Use structured logging** - Makes debugging much easier

## References

- [Linear Webhook Documentation](https://developers.linear.app/docs/graphql/webhooks)
- [LangSmith Agent Builder Docs](https://docs.langchain.com/langsmith/agent-builder)
- [LangGraph SDK Documentation](https://langchain-ai.github.io/langgraph/cloud/reference/sdk/python_sdk_ref/)
- [HMAC Signature Verification Best Practices](https://hookdeck.com/webhooks/guides/how-to-implement-sha256-webhook-signature-verification)
